{{define "body"}}
<div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600">Manage and share your local files</p>
        </div>
        <div
            class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-full text-sm font-medium">
            <i class="fas fa-wifi"></i>
            <span>IP: {{.Ip}}</span>
        </div>
    </div>
</div>

<!-- Upload Zone -->
<!-- <div id="uploadBtn"
    class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-white hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer mb-10">
    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-cloud-upload-alt text-primary text-2xl"></i>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-1">Upload Files</h3>
    <p class="text-gray-500">Click here or drag & drop files anywhere</p>
</div> -->

<button id="uploadBtn" class="flex items-center gap-2 bg-primary text-white px-5 py-2.5 rounded-lg 
           hover:bg-primary/90 transition shadow-sm active:scale-95">
    <i class="fas fa-cloud-upload-alt"></i>
    Upload Files
</button>



<!-- Files Grid -->
<h2 class="text-xl font-bold text-gray-800 mb-4">
    {{if .Data}}Shared Files{{else}}No Files Yet{{end}}
</h2>

{{if .Data}}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
    {{range .Data}}
    <div class="bg-white rounded-xl shadow-sm border hover:shadow-md transition group" data-uploader="{{.UploaderId}}"
        data-uuid="{{.FileUUID}}">
        <div class="p-4">
            <div class="flex justify-center mb-4">
                <div class="w-14 h-14 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">
                    <i class="fas fa-file-alt text-2xl"></i>
                </div>
            </div>

            <h3 class="font-medium text-gray-800 truncate mb-1" title="{{.Metadata.FileName}}">
                {{.Metadata.FileName}}
            </h3>
            <div class="text-sm text-gray-500 space-y-0.5">
                <div><i class="fas fa-hdd text-xs mr-1"></i> {{.FileSize}}</div>
                <div><i class="far fa-clock text-xs mr-1"></i> {{.UploadedAt.Format "Jan 02"}}</div>
            </div>
        </div>

        <div class="border-t px-4 py-3 flex gap-2">
            <button onclick="downloadFileHandler('{{.FileUUID}}', '{{.Metadata.FileName}}')"
                class="flex-1 flex items-center justify-center gap-1.5 text-sm font-medium bg-primary text-white rounded px-3 py-2 hover:bg-blue-600 transition">
                <i class="fas fa-download"></i> Download
            </button>
            <div class="delete-placeholder"></div>
        </div>
    </div>
    {{end}}
</div>
{{else}}
<div class="text-center py-12 bg-white rounded-xl border">
    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
        <i class="fas fa-wind text-2xl"></i>
    </div>
    <p class="text-gray-500">No files shared on this network yet.</p>
</div>
{{end}}

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" id="closeModalBg"></div>
    <div class="relative max-w-lg w-full mx-auto mt-20 bg-white rounded-xl shadow-lg">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Upload File</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="uploadForm">
                <label
                    class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition"
                    id="dropZone">
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-600"><span class="font-medium">Click to upload</span> or drag & drop
                        </p>
                        <p class="text-xs text-gray-500 mt-1">Any file up to 2GB</p>
                    </div>
                    <input type="file" id="fileInput" name="uploadfile" class="hidden" required />
                </label>
                <p class="text-sm text-gray-600 mt-2 text-center" id="fileName">No file selected</p>

                <button type="submit"
                    class="w-full mt-4 bg-primary text-white py-2.5 rounded-lg font-medium hover:bg-blue-600 transition">
                    Start Upload
                </button>

                <progress id="uploadProgress" value="0" max="100" class="w-full h-2 mt-4 rounded-full overflow-hidden">
                    <div class="h-full bg-primary rounded-full"></div>
                </progress>
            </form>
        </div>
    </div>
</div>

<!-- Download Modal -->
<div id="downloadModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative max-w-md w-full mx-auto mt-20 bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Downloading...</h3>
        <p class="text-gray-700 mb-1">File: <span id="downloadFileName" class="font-medium">‚Äî</span></p>
        <progress id="downloadProgress" value="0" max="100" class="w-full h-2 mt-2 rounded-full overflow-hidden">
            <div class="h-full bg-primary rounded-full"></div>
        </progress>
        <p class="text-sm text-gray-500 mt-2" id="downloadStatus">Connecting...</p>
    </div>
</div>

<script>
    $(document).ready(function () {
        const currentUser = getFingerPrint();

        // DOM elements
        const $uploadBtn = $("#uploadBtn");
        const $uploadModal = $("#uploadModal");
        const $closeModal = $("#closeModal, #closeModalBg");
        const $fileInput = $("#fileInput");
        const $fileName = $("#fileName");
        const $dropZone = $("#dropZone");
        const $uploadForm = $("#uploadForm");

        // === Modals ===
        $uploadBtn.on("click", () => $uploadModal.removeClass("hidden"));
        $closeModal.on("click", () => $uploadModal.addClass("hidden"));

        // === File preview ===
        $fileInput.on("change", () => {
            const file = $fileInput[0].files[0];
            $fileName.text(file ? file.name : "No file selected");
        });

        // === Drag & Drop ===
        $dropZone.on("dragenter dragover", e => {
            e.preventDefault(); e.stopPropagation();
            $dropZone.addClass("bg-primary/5 border-primary");
        });
        $dropZone.on("dragleave drop", e => {
            e.preventDefault(); e.stopPropagation();
            $dropZone.removeClass("bg-primary/5 border-primary");
        });
        $dropZone.on("drop", e => {
            const file = e.originalEvent.dataTransfer.files[0];
            if (file) {
                $fileInput[0].files = e.originalEvent.dataTransfer.files;
                $fileName.text(file.name);
            }
        });

        // === Upload logic (unchanged core) ===
        $uploadForm.on("submit", function (e) {
            e.preventDefault();
            const file = $fileInput[0].files[0];
            if (!file) return alert("No file selected");

            const totalSize = file.size;
            const chunkSize = 10 * 1024 * 1024;
            const totalChunks = Math.ceil(totalSize / chunkSize);
            let currentChunk = 0;
            let retryCount = 0;
            const maxRetries = 3;
            const progressBar = $("#uploadProgress");
            const uploadButton = $uploadForm.find('button[type="submit"]');
            const uploadId = generateUUID();

            progressBar.val(0);
            uploadButton.prop("disabled", true);

            function uploadNextChunk() {
                const start = currentChunk * chunkSize;
                const end = Math.min(start + chunkSize, totalSize);
                const blob = file.slice(start, end);
                const formData = new FormData();
                formData.append("uploadId", uploadId);
                formData.append("file", blob);
                formData.append("fileName", file.name);
                formData.append("chunkIndex", currentChunk);
                formData.append("totalChunks", totalChunks);
                formData.append("totalSize", totalSize);
                formData.append("uploaderId", currentUser);

                $.ajax({
                    url: "/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: () => {
                        retryCount = 0;
                        currentChunk++;
                        progressBar.val(Math.round((currentChunk / totalChunks) * 100));
                        if (currentChunk < totalChunks) {
                            uploadNextChunk();
                        } else {
                            showToast("‚úÖ File uploaded!", "green");
                            $uploadModal.addClass("hidden");
                            location.reload();
                        }
                    },
                    error: (xhr) => {
                        uploadButton.prop("disabled", false);
                        if (xhr.status === 507) {
                            showToast("‚ùå Insufficient storage", "red");
                            return;
                        }
                        if (retryCount++ < maxRetries) {
                            setTimeout(uploadNextChunk, 1000);
                        } else {
                            showToast("‚ùå Upload failed", "red");
                        }
                    }
                });
            }
            uploadNextChunk();
        });

        // === Inject Delete Buttons ===
        $(".group").each(function () {
            const uploaderId = $(this).data("uploader");
            const uuid = $(this).data("uuid");
            if (uploaderId === currentUser) {
                const btn = $(`
        <button data-uuid="${uuid}" class="delete-file flex-1 flex items-center justify-center gap-1.5 text-sm font-medium bg-red-500 text-white rounded px-3 py-2 hover:bg-red-600 transition">
          <i class="fas fa-trash"></i> Delete
        </button>
      `);
                $(this).find(".delete-placeholder").replaceWith(btn);
            }
        });

        // === Delete handler ===
        $(document).on("click", ".delete-file", function () {
            const uuid = $(this).data("uuid");
            if (!confirm("‚ö†Ô∏è Are you sure you want to delete this file?")) return;

            $.ajax({
                url: "/delete?fileUUID=" + encodeURIComponent(uuid),
                type: "GET",
                success: () => {
                    showToast("üóëÔ∏è Deleted", "red");
                    location.reload();
                },
                error: () => showToast("Failed to delete", "yellow")
            });
        });

        // === Utils ===
        function showToast(message, color = "blue") {
            const colors = {
                blue: "bg-blue-500",
                green: "bg-green-500",
                red: "bg-red-500",
                yellow: "bg-yellow-500"
            };
            const toast = $(`
      <div class="fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-medium shadow-lg ${colors[color] || colors.blue} z-50 animate-fade-in">
        ${message}
      </div>
    `).appendTo("body");
            setTimeout(() => toast.addClass("animate-fade-out").on("animationend", () => toast.remove()), 2500);
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        function getFingerPrint() {
            let uuid = localStorage.getItem("user_uuid");
            return uuid || (() => {
                uuid = generateUUID();
                localStorage.setItem("user_uuid", uuid);
                return uuid;
            })();
        }
    });

    // Download logic (same as before)
    async function downloadFileHandler(fileUUID, filename = "") {
        if (confirm(`üì• Download "${filename}"?`)) await downloadFile(fileUUID);
    }

    async function downloadFile(fileUUID) {
        try {
            const res = await fetch(`/file-info?fileUUID=${encodeURIComponent(fileUUID)}`);
            if (!res.ok) throw new Error("File info not found");
            const { data: fileInfo } = await res.json();
            const size = fileInfo.file_size;

            const $modal = $("#downloadModal");
            const $progress = $("#downloadProgress");
            const $name = $("#downloadFileName");
            const $status = $("#downloadStatus");

            $name.text(fileInfo.metadata.file_name || "Unknown");
            $status.text("Starting...");
            $progress.val(0);
            $modal.removeClass("hidden");

            const chunkSize = 10 * 1024 * 1024;
            const chunks = Math.ceil(size / chunkSize);
            const blobs = [];

            for (let i = 0; i < chunks; i++) {
                const resp = await fetch(`/download?fileUUID=${encodeURIComponent(fileUUID)}`, {
                    headers: { Range: `bytes=${i * chunkSize}-${Math.min((i + 1) * chunkSize - 1, size - 1)}` }
                });
                if (!resp.ok) throw new Error(`Chunk ${i + 1} failed`);
                blobs.push(await resp.blob());
                $progress.val(Math.round(((i + 1) / chunks) * 100));
                $status.text(`Downloading (${i + 1}/${chunks})...`);
            }

            const blob = new Blob(blobs);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileInfo.metadata.file_name || fileUUID;
            a.click();
            URL.revokeObjectURL(url);

            $modal.addClass("hidden");
            showToast("‚úÖ Download complete!", "green");

        } catch (err) {
            console.error(err);
            showToast(`‚ùå ${err.message || "Failed"}`, "red");
            $("#downloadModal").addClass("hidden");
        }
    }
</script>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fade-out {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
    }

    .animate-fade-out {
        animation: fade-out 0.3s ease-out forwards;
    }
</style>
{{end}}