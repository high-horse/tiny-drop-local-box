{{/* home.html */}}
<div style="padding: 0; margin: 0;">
    <!-- Upload button triggers modal -->
    <div style="display: flex; justify-content: space-between;">

        <div>
            <button class="button is-primary" id="uploadBtn">Upload File</button>
        </div>
        <div>
            <span>Your Ip is {{.Ip}}</span>
        </div>
    </div>

    
</div>

<!-- Bulma modal for file upload -->
<div class="modal" id="uploadModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Upload your file</p>
            <button class="delete" aria-label="close" id="closeModal"></button>
        </header>
        <section class="modal-card-body">
            <form id="uploadForm" method="post" enctype="multipart/form-data" action="/upload">
                <div class="file has-name is-boxed is-fullwidth" id="dropZone">
                    <label class="file-label">
                        <input class="file-input" type="file" name="uploadfile" id="fileInput" required />
                        <span class="file-cta">
                            <span class="file-icon">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="file-label">Choose a fileâ€¦ or drag it here</span>
                        </span>
                        <span class="file-name" id="fileName">No file selected</span>
                    </label>
                </div>
                <br />
                <button type="submit" class="button is-success is-fullwidth">
                    Upload
                </button>
            </form>
            <progress id="uploadProgress" class="progress is-primary" value="0" max="100"
                style="width: 100%; margin-top: 10px"></progress>
        </section>
    </div>
</div>

<section class="section">
    <div class="container">
        <h1 class="title">Uploaded Files</h1>
        <div class="columns is-multiline">
            {{if .Data}}
            {{range .Data}}
            <div class="column is-3">
                <div class="card has-hover" data-uploader="{{.UploaderId}}" data-uuid="{{.FileUUID}}">
                    <div class="card-content">
                        <p class="title is-6">{{.Metadata.FileName}}</p>
                        <p class="subtitle is-7">

                            <span class="icon-text">
                                <span class="icon">
                                    <i class="fas fa-hdd"></i> <!-- File Size Icon -->
                                </span>
                                <span>SIze: <strong>{{.FileSize}}</strong></span>
                            </span>

                            <span class="icon-text">
                                <span class="icon">
                                    <i class="fas fa-upload"></i> <!-- Upload Icon -->
                                </span>
                                <span>Uploaded At : <strong>{{.UploadedAt.Format "2006-01-02 15:04:05"}}</strong></span>
                            </span>
                            <span class="icon-text">
                                <span class="icon">
                                    <i class="fas fa-download"></i> <!-- Download Icon -->
                                </span>
                                <span>Last Download at: <strong>{{.LastDownloadAt.Format "2006-01-02 15:04:05"}}</strong></span>
                            </span>
                            <span class="icon-text">
                                <span class="icon">
                                    <i class="fas fa-trash-alt"></i> <!-- Trash Icon -->
                                </span>
                                <span>Delete at: <strong>{{.WillDeleteAt.Format "2006-01-02 15:04:05"}}</strong></span>
                            </span>
                        </p>
                    </div>
                    <footer class="card-footer">
                        <!-- <a href="/download/{{.FileUUID}}" class="card-footer-item">
                            <span class="icon"><i class="fas fa-arrow-circle-down"></i></span> Download
                        </a> -->
                        <a href="javascript:void(0)" class="card-footer-item" onclick="downloadFileHandler('{{.FileUUID}}', '{{.FileName}}')">
                            <span class="icon"><i class="fas fa-arrow-circle-down"></i></span> Download
                        </a>
                        <span class="card-footer-item delete-container"></span>
                    </footer>
                </div>
            </div>
            {{end}}
            {{else}}
            <p>No files uploaded yet.</p>
            {{end}}
        </div>
    </div>
</section>

<!-- Download progress  -->
<div class="modal" id="downloadModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Downloading File</p>
            <!-- <button class="delete" aria-label="close" id="closeDownloadModal"></button> -->
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p id="downloadFileName">File Name: <strong></strong></p>
                <progress id="downloadProgress" class="progress is-primary" value="0" max="100" style="width: 100%;"></progress>
                <p id="downloadStatus">Downloading...</p>
            </div>
        </section>
    </div>
</div>

<!-- Modal Structure -->
<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <p id="confirmMessage">Are you sure?</p>
        <div class="modal-actions">
        <button id="confirmOkBtn" class="modal-btn ok-btn">OK</button>
        <button id="confirmCancelBtn" class="modal-btn cancel-btn">Cancel</button>
        </div>
    </div>
</div>


<!-- <div class="section">
    <h2>Contact</h2>
    <b>Title = {{.Title}}</b>
    <p>Desc: <strong>{{ .Desc }}</strong></p>
</div> -->

<!-- Modal and drag-and-drop script -->
<script>
    $(document).ready(function () {
        const currentUser = getFingerPrint();

        const $uploadBtn = $("#uploadBtn");
        const $uploadModal = $("#uploadModal");
        const $closeModal = $("#closeModal");
        const $fileInput = $("#fileInput");
        const $fileName = $("#fileName");
        const $dropZone = $("#dropZone");
        const $uploadForm = $("#uploadForm");

        // Open modal
        $uploadBtn.click(() => {
            $uploadModal.addClass("is-active");
        });

        // Close modal
        $closeModal.click(() => {
            $uploadModal.removeClass("is-active");
            resetFileInput();
        });
        $uploadModal.find(".modal-background").click(() => {
            $uploadModal.removeClass("is-active");
            resetFileInput();
        });

        // File input change update file name
        $fileInput.on("change", () => {
            if ($fileInput[0].files.length > 0) {
                $fileName.text($fileInput[0].files[0].name);
            } else {
                $fileName.text("No file selected");
            }
        });

        // Drag & Drop handlers (same as before, using jQuery event handlers)
        $dropZone.on("dragenter dragover dragleave drop", function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        $dropZone.on("dragover", function () {
            $dropZone.addClass("is-hovered");
        });

        $dropZone.on("dragleave drop", function () {
            $dropZone.removeClass("is-hovered");
        });

        $dropZone.on("drop", function (e) {
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $fileInput[0].files = files;
                $fileName.text(files[0].name);
            }
        });

        $("#uploadForm").on("submit", function (e) {
            e.preventDefault();

            const file = $("#fileInput")[0].files[0];
            if (!file) return alert("No file selected");

            console.log("Size in MB:", (file.size / 1_000_000).toFixed(2));
            // return;

            const totalSize = file.size;
            const chunkSize = 10 * 1024 * 1024; // 2MB per chunk
            const totalChunks = Math.ceil(file.size / chunkSize);
            let currentChunk = 0;
            const maxRetries = 3;
            let retryCount = 0;

            const progressBar = $("#uploadProgress");
            const uploadButton = $(this).find('button[type="submit"]');
            const uploadId = generateUUID();

            progressBar.val(0); // reset
            uploadButton.prop('disabled', true);

            function uploadNextChunk() {
                const start = currentChunk * chunkSize;
                const end = Math.min(file.size, start + chunkSize);
                const blob = file.slice(start, end);

                const formData = new FormData();
                formData.append('uploadId', uploadId);
                formData.append("file", blob);
                formData.append("fileName", file.name);
                formData.append("chunkIndex", currentChunk);
                formData.append("totalChunks", totalChunks);
                formData.append("totalSize", totalChunks);
                formData.append("uploaderId", currentUser);


                $.ajax({
                    url: "/upload",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        retryCount = 0;
                        currentChunk++;
                        const progress = Math.round(
                            (currentChunk / totalChunks) * 100,
                        );
                        progressBar.val(progress);

                        if (currentChunk < totalChunks) {
                            uploadNextChunk();
                        } else {
                            showToast(
                                "File uploaded successfully!",
                                "is-success",
                            );
                            $("#uploadModal").removeClass("is-active");
                            $("#fileInput").val("");
                            $("#fileName").text("No file selected");
                            progressBar.val(0);
                            uploadButton.prop('disabled', false);
                            window.location.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        if (xhr.status == 507) { // check the HTTP status code
                            showToast(error || "Insuffecient Storage", "is-danger",)
                            // alert("Upload failed: server storage insufficient (507)");
                            uploadButton.prop('disabled', false);
                            progressBar.val(0);
                            return; // EARLY EXIT, stop retrying
                        }
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(
                                `Retrying chunk ${currentChunk}, attempt ${retryCount}`,
                            );
                            setTimeout(uploadNextChunk, 1000);
                        } else {
                            showToast(
                                "Upload failed after retries: " + error,
                                "is-danger",
                            );
                            uploadButton.prop('disabled', false);
                        }
                    },
                });
            }

            uploadNextChunk();
        });

        function resetFileInput() {
            $fileInput.val("");
            $fileName.text("No file selected");
        }

        function generateUUID() {
            // Simple UUIDv4 generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        function getFingerPrint() {
            let userUuid = localStorage.getItem("user_uuid");
            if (!userUuid) {
                userUuid = generateUUID();
                localStorage.setItem("user_uuid", userUuid);
            }

            return userUuid;
        }

        $(".card").each(function () {
            const uploaderId = $(this).data("uploader");
            const fileUuid = $(this).data("uuid");

            if (uploaderId === currentUser) {
                const deleteBtn = $(`
                <a class="card-footer-item has-text-danger delete-file" data-uuid="${fileUuid}">
                    <span class="icon"><i class="fas fa-trash"></i></span> Delete
                </a>
            `);

                $(this).find(".delete-container").append(deleteBtn);
            }
        });

        // Handle delete click
        $(document).on("click", ".delete-file", function () {
            const uuid = $(this).data("uuid");
            if (!confirm("Are you sure you want to delete this file?")) return;

            $.ajax({
                url: "/delete?fileUUID=" + uuid,
                type: "GET",
                success: function () {
                    showToast("File deleted!", "is-danger");
                    location.reload();
                },
                error: function () {
                    showToast("Failed to delete!", "is-warning");
                }
            });
        });

    });

    function showToast(message, type = "is-success") {
        const toast = $(`
            <div class="notification ${type}" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                ${message}
                <button class="delete"></button>
            </div>
        `);
        $("body").append(toast);
        toast.find(".delete").on("click", () => toast.remove());
        setTimeout(() => toast.remove(), 3000);
    }

    function showConfirmationDialog(message) {
        return window.confirm(message);
    }
    async function downloadFileHandler(fileUUID, filename = "") {
        const result = showConfirmationDialog(`Are you sure you want to Download this file "${filename}"?`);
        if (result) {
            await downloadFile(fileUUID);
        } else {
            console.log("File not deleted");
        }
    }

    async function downloadFile(fileUUID) {
        try {
            // Get the file's total size (you should add an endpoint to retrieve this info)
            const fileInfoResponse = await fetch(`/file-info?fileUUID=${fileUUID}`);
            if (!fileInfoResponse.ok) {
                throw new Error('Unable to fetch file info');
            }
            const parsed = await fileInfoResponse.json();
            const fileInfo = parsed.data;
            const fileSize = fileInfo.file_size; // Total size of the file in bytes

            // Setup the download progress modal
            const $downloadModal = $("#downloadModal");
            const $progressBar = $("#downloadProgress");
            const $fileName = $("#downloadFileName strong");
            const $downloadStatus = $("#downloadStatus");
            const chunkSize = 10 * 1024 * 1024; // 10MB in bytes
            const totalChunks = Math.ceil(fileSize / chunkSize); // Total number of chunks

            $fileName.text(fileInfo.metadata.file_name);
            $downloadStatus.text("Downloading...");
            $progressBar.val(0);
            $downloadModal.addClass("is-active");

            let currentChunk = 0;
            const fileBlob = [];

            // Download file in chunks
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize - 1, fileSize - 1); // Ensure end does not exceed file size
                const rangeHeader = `bytes=${start}-${end}`;

                const response = await fetch(`/download?fileUUID=${fileUUID}`, {
                    method: 'GET',
                    headers: {
                        'Range': rangeHeader,
                    },
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch chunk ${i + 1}`);
                }

                const chunkBlobData = await response.blob(); // Get the current chunk as a blob
                fileBlob.push(chunkBlobData); // Add the chunk to the fileBlob array

                // Update the progress bar
                currentChunk++;
                const progress = Math.round((currentChunk / totalChunks) * 100);
                $progressBar.val(progress);
            }

            // Combine the blobs into a single blob (i.e., the complete file)
            const completeFileBlob = new Blob(fileBlob);

            // Create a download link for the complete file
            const url = URL.createObjectURL(completeFileBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileInfo.file_name;  // You can change this to a specific filename if needed
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Close the download modal after download
            $downloadModal.removeClass("is-active");
            showToast("File downloaded successfully!", "is-success");

        } catch (error) {
            console.error("Error downloading file:", error);
            showToast("There was an error downloading the file.", "is-danger");
            const $downloadModal = $("#downloadModal");
            $downloadModal.removeClass("is-active");
        }
    }

    async function downloadFile_(fileUUID) {
        try {
            // Get the file's total size (you should add an endpoint to retrieve this info)
            const fileInfoResponse = await fetch(`/file-info?fileUUID=${fileUUID}`);
            if (!fileInfoResponse.ok) {
                throw new Error('Unable to fetch file info');
            }
            const parsed = await fileInfoResponse.json();
            const fileInfo = parsed.data;
            console.log("fileingo is ", fileInfo);
            // return
            
            const fileSize = fileInfo.file_size; // Total size of the file in bytes

            const chunkSize = 10 * 1024 * 1024; // 10MB in bytes
            const totalChunks = Math.ceil(fileSize / chunkSize); // Total number of chunks

            // Create a blob array to accumulate the file data
            let fileBlob = [];

            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize - 1, fileSize - 1); // Ensure end does not exceed file size

                const rangeHeader = `bytes=${start}-${end}`;

                // Request the current chunk
                const response = await fetch(`/download?fileUUID=${fileUUID}`, {
                    method: 'GET',
                    headers: {
                        'Range': rangeHeader,
                    },
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch chunk ${i + 1}`);
                }

                const chunkBlob = await response.blob(); // Get the current chunk as a blob
                fileBlob.push(chunkBlob); // Add the chunk to the fileBlob array
            }

            // Combine the blobs into a single blob (i.e., the complete file)
            const completeFileBlob = new Blob(fileBlob);

            // Create a download link for the complete file
            const url = URL.createObjectURL(completeFileBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileUUID;  // You can change this to a specific filename if needed
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

        } catch (error) {
            console.error("Error downloading file:", error);
            alert("There was an error downloading the file.");
        }
    }

</script>

<style>
    /* Drag & drop highlight style */
    .file.is-hovered {
        border-color: #79a8ff;
        background-color: #2a2d34;
        box-shadow: 0 0 10px #79a8ff;
        transition: all 0.3s ease;
    }

    #downloadModal {
        z-index: 9999;
    }

    .card{
        max-width: 350px; /* Set max width (you can adjust this value as needed) */
        max-height: 500px; /* Set max height (you can adjust this value as needed) */
        overflow: hidden;
    }
    .card.has-hover:hover {
        transform: translateY(-5px); /* Slightly lift the card */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
    }

    /* Button (Download link) hover effect */
    .card-footer-item.is-hoverable:hover {
        background-color: #f5f5f5; /* Light background on hover */
        color: #3273dc; /* Change text color on hover */
        transform: scale(1.05); /* Slightly scale up on hover */
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    /* Prevent the modal from closing when clicking the background */
    #uploadModal .modal-background {
        pointer-events: none; /* Disable pointer events on the background */
    }

    /* Ensure the modal's close button still works */
    #uploadModal .delete {
        pointer-events: all; /* Allow clicking on the close button */
    }

</style>